#!/usr/bin/env bash
################################################################################
# Runs all the tests using randomized values for number of packets, fill
# character and packets length.
################################################################################

random_num="$((65 + $RANDOM % 58))"
# https://stackoverflow.com/a/10503163
random_fill=$(printf \\$(printf '%03o' $random_num))
# We need to make sure that we can send this number of packets with this length
# at once. At the moment i just put max values which works for the defaults
# number of rings and buffer size.
random_len="$((50 + $RANDOM % 10000))"
random_packet_num="$((1 + $RANDOM % 100))"
# Use and empty string instead of "-q" if you don't want to perform a sequential
# send/receive check
seq_check="-q"
echo "Running tests with"
echo "   number of packets: ${random_packet_num}"
echo "   fill character   : ${random_fill}"
echo "   sequence check   : ${seq_check}"
echo "   packet length    : ${random_len}"
echo ""

./persistent_vale_port_destroy
./persistent_vale_port_double_create
./persistent_vale_port_double_attach

./exclusive_open_ephemeral_vale_port_test
./exclusive_open_persistent_vale_port_test
./exclusive_open_pipe_test

./learning_bridge_test -l $random_len -f $random_fill

./send_rec_pipe_test                  -n $random_packet_num -l $random_len -f $random_fill "$seq_check"
./send_rec_ephemeral_vale_ports_test  -n $random_packet_num -l $random_len -f $random_fill "$seq_check"
./send_rec_persistent_vale_ports_test -n $random_packet_num -l $random_len -f $random_fill "$seq_check"
# ./send_rec_veth_test                 -n $random_packet_num -l $random_len -f $random_fill "$seq_check"
./partial_read_pipe_test              -n $random_packet_num -l $random_len -f $random_fill "$seq_check"

./rec_cp_mon_pipe_test                  -n $random_packet_num -l $random_len -f $random_fill "$seq_check"
./rec_cp_mon_persistent_vale_port_test  -n $random_packet_num -l $random_len -f $random_fill "$seq_check"
./rec_cp_mon_ephemeral_vale_port_test   -n $random_packet_num -l $random_len -f $random_fill "$seq_check"
./rec_zcp_mon_pipe_test                 -n $random_packet_num -l $random_len -f $random_fill "$seq_check"
./rec_zcp_mon_persistent_vale_port_test -n $random_packet_num -l $random_len -f $random_fill "$seq_check"
./rec_zcp_mon_ephemeral_vale_port_test  -n $random_packet_num -l $random_len -f $random_fill "$seq_check"

./send_cp_mon_pipe_test                  -n $random_packet_num -l $random_len -f $random_fill "$seq_check"
./send_cp_mon_persistent_vale_port_test  -n $random_packet_num -l $random_len -f $random_fill "$seq_check"
./send_cp_mon_ephemeral_vale_port_test   -n $random_packet_num -l $random_len -f $random_fill "$seq_check"
./send_zcp_mon_pipe_test                 -n $random_packet_num -l $random_len -f $random_fill "$seq_check"
./send_zcp_mon_persistent_vale_port_test -n $random_packet_num -l $random_len -f $random_fill "$seq_check"
./send_zcp_mon_ephemeral_vale_port_test  -n $random_packet_num -l $random_len -f $random_fill "$seq_check"


./extra_buf_send_rec_pipe_test                  -n $random_packet_num -l $random_len -f $random_fill "$seq_check"
./extra_buf_send_rec_ephemeral_vale_ports_test  -n $random_packet_num -l $random_len -f $random_fill "$seq_check"
./extra_buf_send_rec_persistent_vale_ports_test -n $random_packet_num -l $random_len -f $random_fill "$seq_check"